<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Orbit Onboarding Assistant</title>
  <link rel="icon" href="/static/logo.svg">
  <link rel="stylesheet" href="/static/styles.css"/>
</head>
<body class="teams">
  <div class="shell-teams">

    <!-- LEFT RAIL (Teams-like) -->
    <aside class="rail">
      <div class="rail-top">
        <div class="rail-logo" title="OrbitOA">üõ∞Ô∏è</div>
        <button class="rail-btn active" title="Assistant" data-panel="assistant">üí¨</button>
        <button class="rail-btn" title="Quick Ask" data-panel="quick">‚ö°</button>
      </div>
      <div class="rail-bottom">
        <button class="rail-btn" id="themeToggle" title="Toggle theme">‚òº</button>
      </div>
    </aside>

    <!-- MAIN COLUMN -->
    <div class="main">
      <header class="topbar-teams">
        <div class="left">
          <h1>Orbit Onboarding Assistant</h1>
          <span class="muted">Your AI buddy for fast, accurate onboarding answers</span>
        </div>
        <div class="right">
          <a class="btn outline" href="/admin">Admin</a>
        </div>
      </header>

      <nav class="tabs">
        <button class="tab active" data-tab="chat">Chat</button>
        <button class="tab" data-tab="ask">Quick Ask</button>
      </nav>

      <main class="content">
        <!-- CHAT TAB -->
        <section class="tabpanel active" id="tab-chat">
          <div class="chat-wrap card">
            <div id="chat" class="chat">
              <div class="msg bot">
                <div class="avatar">üõ∞Ô∏è</div>
                <div class="bubble">
                  <div class="name">OrbitOA</div>
                  <div>Hi! Ask me about VPN, Wi-Fi, HR policies, tools access, and more.</div>
                  <div class="sources"></div>
                </div>
              </div>
            </div>

            <div class="composer">
              <div class="quick">
                <button class="chip" data-q="How do I connect to VPN?">VPN Setup</button>
                <button class="chip" data-q="What is our annual leave policy?">Leave Policy</button>
                <button class="chip" data-q="How do I access the HR Portal?">HR Portal</button>
                <button class="chip" data-q="How do I join the corporate Wi-Fi?">Wi-Fi</button>
              </div>
              <div class="compose-row">
                <textarea id="q" class="input" rows="1" placeholder="Type a message‚Ä¶ (Enter to send, Shift+Enter = new line)"></textarea>
                <button id="ask" class="btn primary">Send</button>
              </div>
            </div>
          </div>
        </section>

        <!-- QUICK ASK TAB -->
        <section class="tabpanel" id="tab-ask">
          <div class="card ask-card">
            <h2>Quick Ask</h2>
            <p class="muted small">One-shot questions (no chat history).</p>

            <label class="field">
              <span>Question</span>
              <input id="quickQuestion" class="input" placeholder="e.g., What‚Äôs the probation policy?"/>
            </label>

            <div class="actions-row">
              <button id="quickAskBtn" class="btn primary">Ask</button>
              <button id="clearBtn" class="btn outline">Clear</button>
            </div>

            <div class="result" id="quickResult" hidden>
              <h3>Answer</h3>
              <pre id="quickAnswer"></pre>
              <div id="quickSources" class="sources"></div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div id="toast" class="toast" hidden></div>

  <script>
    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.tabpanel');
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('tab-' + t.dataset.tab).classList.add('active');
    }));

    // Rail buttons
    const railBtns = document.querySelectorAll('.rail-btn[data-panel]');
    railBtns.forEach(b => b.addEventListener('click', () => {
      railBtns.forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      const target = b.dataset.panel === 'assistant' ? 'chat' : 'ask';
      document.querySelector('.tab[data-tab="'+target+'"]').click();
    }));

    // Theme toggle
    const root = document.documentElement;
    document.getElementById('themeToggle').addEventListener('click', () => {
      root.classList.toggle('light');
    });
    window.addEventListener('keydown', e => { if(e.key.toLowerCase()==='t') root.classList.toggle('light'); });

    // Toast
    const toast = document.getElementById('toast');
    function showToast(text){ toast.textContent = text; toast.hidden = false; setTimeout(()=>toast.hidden = true, 2200); }

    // Chat helpers
    const chat = document.getElementById('chat');
    const q = document.getElementById('q');
    function add(role, text, sources=[]) {
      const wrap = document.createElement('div'); wrap.className = 'msg ' + role;
      const av = document.createElement('div'); av.className='avatar'; av.textContent = role==='user'?'üßë':'üõ∞Ô∏è';
      const b = document.createElement('div'); b.className='bubble';
      const n = document.createElement('div'); n.className='name'; n.textContent = role==='user'?'You':'OrbitOA';
      const d = document.createElement('div'); d.textContent = text;
      b.append(n,d);
      if (role==='bot' && sources.length){
        const s = document.createElement('div'); s.className='sources';
        sources.forEach(src => { const c = document.createElement('span'); c.className='chip src'; c.textContent=src; s.appendChild(c); });
        b.appendChild(s);
      }
      wrap.append(av,b);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
    }
    function thinking() {
      const wrap = document.createElement('div'); wrap.className='msg bot thinking';
      wrap.innerHTML = '<div class="avatar">üõ∞Ô∏è</div><div class="bubble"><div class="name">OrbitOA</div><div class="dots"><span></span><span></span><span></span></div></div>';
      chat.appendChild(wrap); chat.scrollTop = chat.scrollHeight; return wrap;
    }

    // Chat send
    async function sendChat(){
      const text = q.value.trim();
      if(!text) return showToast('Type a message first');
      add('user', text);
      q.value='';
      const t = thinking();
      try{
        const res = await fetch('/api/ask', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query: text})});
        const data = await res.json();
        t.remove();
        add('bot', data.answer || 'No answer.', (data.sources||[]));
      }catch(e){
        t.remove();
        add('bot', 'Sorry, something went wrong.');
      }
    }
    document.getElementById('ask').addEventListener('click', sendChat);
    q.addEventListener('keydown', e => {
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
    });
    document.querySelectorAll('.chip[data-q]').forEach(c => c.addEventListener('click', ()=>{
      q.value = c.dataset.q; sendChat();
    }));

    // QUICK ASK
    const quickBtn = document.getElementById('quickAskBtn');
    const quickQ = document.getElementById('quickQuestion');
    const quickRes = document.getElementById('quickResult');
    const quickAns = document.getElementById('quickAnswer');
    const quickSrc = document.getElementById('quickSources');
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      quickQ.value=''; quickRes.hidden = true; quickAns.textContent=''; quickSrc.innerHTML='';
    });

    async function quickAsk(){
      const text = quickQ.value.trim();
      if(!text) return showToast('Enter a question first');
      quickRes.hidden = false;
      quickAns.textContent = 'Thinking‚Ä¶';
      quickSrc.innerHTML = '';
      try{
        const res = await fetch('/api/ask', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query: text})});
        const data = await res.json();
        quickAns.textContent = data.answer || 'No answer.';
        (data.sources||[]).forEach(s => {
          const chip = document.createElement('span'); chip.className='chip src'; chip.textContent = s;
          quickSrc.appendChild(chip);
        });
      }catch(e){
        quickAns.textContent = 'Sorry, something went wrong.';
      }
    }
    quickBtn.addEventListener('click', quickAsk);
    quickQ.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); quickAsk(); } });
  </script>
</body>
</html>
